{% extends base %}
{% load static %}
{% load i18n %}

{% block headscript%}
<script id="csrf_token" type="application/json">{{csrf_token}}</script>
{{apparatus.config|json_script:"apparatus-config"}}
{{apparatus.id|json_script:"apparatus-id"}}
{{protocol.config|json_script:"protocol-config"}}
{{protocol.id|json_script:"protocol-id"}}
{{execution_json|json_script:"execution-config"}}
{{final_result|json_script:"final-result"}}
{{apparatus.apparatus_type.name|json_script:"apparatus-name"}}

{{video_config|json_script:"video-config"}}

<script>
    var next_result_id =0;

    X_CSRFToken = document.getElementById('csrf_token').textContent

    protocol_config = JSON.parse(document.getElementById('protocol-config').textContent)

    protocol_input_arguments = protocol_config.properties

    current_execution = JSON.parse(document.getElementById('execution-config').textContent);

    var execution_status;
    execution_status = current_execution['status']
    if (execution_status === undefined)
         execution_status = ''


    var apparatus_id = JSON.parse(document.getElementById('apparatus-id').textContent);
    var protocol_id = JSON.parse(document.getElementById('protocol-id').textContent);

</script>


{% endblock %}


{% block head %}

    <!-- datatables -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.semanticui.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.semanticui.min.css">


    <!-- datatables  buutons (copy , csv excel)-->
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.semanticui.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.semanticui.min.css">


    <!-- Video -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/8.0.0/adapter.min.js" ></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js"></script>


    {% block experiment_head %}
    {% endblock %} 


{% endblock %}  



{% block content %}

  
<div class="right floated thirteen wide computer sixteen wide phone column"  id="content">
    <div class="ui container">
        <h1 >{{apparatus.apparatus_type.name}} {{apparatus.id}} in {{apparatus.location}}</h1>
         <div class="ui two column grid container">
            <div class="column">
                <div class="ui icon buttons">
                    <button class="ui button" onclick="open_video_window()">
                        <i class="play icon"></i>
                        Open Video
                    </button>
                    <button class="ui button" onclick="close_video_window()">
                        <i class="stop icon"></i>
                        Close Video
                    </button>
                </div>
            </div>
            <div class="column">
<!--                (<span id="exec_status"></span>) -->
                <div class="ui info floating message" id="exec_status">
                    <div class="header">
                        Experiment execution status
                      </div>
                      <p></p>
                </div>
            </div>
        </div>
    </div> 

          
    <div class="ui  container ">

    <div class="ui top attached tabular menu">
        <a class="item" id="description-tab-slip" data-tab="description-tab">{% trans 'Description' %}</a>
        <a class="active item" id="configuration-tab-slip" data-tab="configuration-tab">{% trans 'Configuration'%}</a>
        <a class="item" id="execution-tab-slip" data-tab="execution-tab">{% trans 'Execution'%}</a>


    </div>

    <!-- MANDATORY EXPERIMENT DESCRIPTION FROM DB -->
    <div class="ui bottom attached tab segment" data-tab="description-tab" >
        <div class="ui grid" >
            <div class="ten wide column ">
                <!--<figure class="" >
                    <img
                    src="{% with 'free/images/'|add:apparatus.apparatus_type.slug|add:'.png' as image_static %}
                    {% static image_static %}
                    {% endwith %}"
                    alt="{{apparatus.apparatus_type.slug}}"
                    width="100%">
                </figure>-->
                 <figure class="" >
                         <img src="{{apparatus.image.url}}" alt="{{apparatus.apparatus_type.slug}}" width="100%"> 
                 </figure>
            </div>
            <!--<div class="six wide column ">
                    <img src="{% static 'free/images/WPA.jpeg' %}" width="100%">
            </div>-->
        </div>
        {{apparatus.apparatus_type.description|safe}}
        <!--<h2> Details</h2>-->
        {{apparatus.description|safe}}
        <!--<h2> Protocol details</h2>-->
        {{protocol.description|safe}}
        <!--end of the description-->
    </div>    
                
                


    <div  class="ui active bottom attached tab segment "  data-tab="configuration-tab">
        
        <h2>{% trans 'Configuration data'%}</h2>

        <div id="config-input" class="ui equal width aligned padded">
            <div class="ui container">
                <div class="ui right pointing label">
                    {% trans 'Execution name:' %}
                </div>
                <div class="ui input" >
                    <input type="text" onchange="onInputChanged()" id="execution_name"  placeholder="New Execution">
                </div>

            </div>
            <div class="ui section divider"></div>
            {% block configtab %}
            <!-- TAB CONTENT WILL BE INJECTED HERE -->
            {% endblock %}
        </div>

        <div class="ui divider"></div>
        <div class="row">   
            <div class="column">
                <div class="ui blue button " onclick="create_experiment()" id="createButton">{% trans 'Create'%}</div>
                <div class="ui blue button" onclick="save_experiment()" id="saveButton">{% trans 'Save'%}</div>
                <div class="ui green button" onclick="submit_experiment()" id="startButton">{% trans 'Submit'%}</div>
                <div class="ui orange button" id="reloadButton" onclick="reloadInputValues()">{% trans 'Reload Values'%}</div>
                <div class="ui orange button" id="resetButton" onclick="resetInputValues()">{% trans 'Reset to default'%}</div>
                <div class="ui green button" id="createNewExpButton" onclick="gotoCreateExecution()">{% trans 'Create New Execution'%}</div>
            {% if not STRIPPED %}
                <div class="ui red button" id="deleteButton" onclick="deleteExecution()">{% trans 'Delete'%} {% trans 'Execution'%}</div>
                <div class="ui red button" id="deleteResultsButton" onclick="deleteExecution()">{% trans 'Delete'%} {% trans 'Results'%}</div>
            {% endif %}
            </div>
            <div class="ui floating message hidden" id="buttonMessage">
                <p>Way to go!</p>
                </div>
        </div>
    </div>
    <div class="ui bottom attached tab segment " data-tab="execution-tab">
        {% comment %}
                <div class="ui red button hiden" id="replayButton" onclick="replayExecution()">{% trans 'Replay'%} {% trans 'Execution'%}</div>
        {% endcomment %}
        {% block executiontab %}
        {% endblock %}
    </div>

    </div>
</div>

{% endblock %}




{% block script %}
    
    {% block protocol_auxiliary_functions %}
    {% endblock%}
<script>

var apparatus_video_window

function open_video_window(){
    if(apparatus_video_window == undefined)
        apparatus_video_window = window.open("{% url "free:apparatus-Video" apparatus.id %}", "_blank", "popup")
}

function close_video_window(){
    apparatus_video_window.close()
    apparatus_video_window = undefined
}
$( window ).on( "unload",function() {
    apparatus_video_window.close()
});




function gotoCreateExecution(){
    {% if not STRIPPED %}
        window.location.href = '/execution/create/'+current_execution.apparatus+'/'+current_execution.protocol.id
    {% else %}
        window.location.href = '/execution/create/'+current_execution.apparatus+'/'+current_execution.protocol.id+'/bare'
   {% endif %}

}


function submit_experiment() {
    executionID = current_execution.id;
    endpoint="/api/v1/execution/"+executionID+"/start";
    HEADERS = {
      "X-CSRFToken": X_CSRFToken,
      }
    axios({
      method: 'put', 
      url: endpoint,
      headers: HEADERS,
    }).then(response => {
      console.log('execution results', response);
      //execution_status = 'NS'
      //  update_button_info(execution_status)
      execution_status = 'Q'
      update_tab_visibility()
        update_button_input_status(execution_status)
        popup_message("experiment submited")
        start_pooling_queue_order()
        next_result_id = 0;
        
    }).catch(error => {
      if (error.response !== undefined) {
      console.error('Error : ', error.response.data);
      popup_message("error submiting experimnet")
      }
    });
}


function start_pooling_queue_order() {
       // Results = setInterval(getData,500)
       get_queue_order();
    }
function get_queue_order(){
    executionID = current_execution.id;
    endpoint =  "/api/v1/execution/"+executionID;
    console.log(next_result_id);
    HEADERS = {
      "X-CSRFToken": X_CSRFToken,
      }
    axios({
        method: 'get', //you can set what request you want to be
        url: endpoint,
        headers: HEADERS,
    }).then(response => {
        order =  response.data.order
        console.log('execution order', order);
        $("#exec_status > p").html("Experiment saved and submited, on position "+order+"of queue")
        if (order <= 1){
            start_pooling_results()
        }else{
            setTimeout(get_queue_order, 5000);
        }

    }).catch(error => {
        console.error('Error : ', error.response.data);
    });
}



function start_pooling_results() {
       // Results = setInterval(getData,500)
       setTimeout(getData, 500);
    }

function getData(){
    executionID = current_execution.id;
    endpoint =  "/api/v1/execution/"+executionID+"/result/"+next_result_id+'/50';
    console.log(next_result_id);
    HEADERS = {
      "X-CSRFToken": X_CSRFToken,
      }
    axios({
        method: 'get', //you can set what request you want to be
        url: endpoint,
        headers: HEADERS,
    }).then(response => {
        console.log('plotly_results', response);
        data_len = response.data.length
        console.log(data_len)
        if (data_len > 0){
        //    table_insert_experiment_data(response.data)
            process_experiment_data(response.data)
            if(response.data[data_len-1].result_type ==='p'){
                execution_status = 'R'
                update_button_input_status(execution_status)
                next_result_id =response.data[data_len-1].id+1
                setTimeout(getData, 500);
            }
            if(next_result_id != 0 && response.data[data_len-1].result_type ==='f'){
                execution_status = 'F'
                update_button_input_status(execution_status)
                next_result_id =response.data[data_len-1].id+1
            }
            if(next_result_id == 0 && response.data[data_len-1].result_type ==='f'){
                execution_status = 'F'
                update_button_input_status(execution_status)
                next_result_id =response.data[data_len-1].id+1
            }
        }else{
            setTimeout(getData, 500);
        }

    }).catch(error => {
        console.error('Error : ', error.response.data);
    });
    
}


function process_experiment_data_default(data){
    for (line in data){
        console.log(data[line])
        if(data[line].result_type == 'p'){
            table_insert_partial_data_default(data[line])
            process_partial_data(data[line])
        }
        if(data[line].result_type == 'f'){
            process_final_data(data[line])
        }
    }
}




function table_insert_partial_data_default(data){
    console.log(data)
    table_columns = jQuery( "#results_table > thead> tr> th" );
    col_id = []
    for ( ind = 0, len = table_columns.length; ind < len; ind++ ) {
        col_id.push($(table_columns[ind]).attr("id"))
    }
    var t = $('#results_table').DataTable();
    row_data = []
    for (c_id in col_id){
        console.log(data.value)
        console.log(col_id[c_id])
        row_data.push(data.value[col_id[c_id]])
    }

    t.row.add(row_data).draw()
}






function popup_message(str){
    $("#buttonMessage").show()
    $("#buttonMessage").html(str)
    setTimeout(function() {
        $("#buttonMessage").hide('blind', {}, 500)
    }, 3000);
}  

function resetInputValues(){

  	input_list = jQuery( ".free-input" );
    let check_helper = 1;
  	for ( ind = 0, len = input_list.length; ind < len; ind++ ) {
        	i = $(input_list[ind]);
        	console.log(["checkbox"].includes(input_list[ind].type))
        	if(["radio"].includes(input_list[ind].type) )
        	{
            		//console.log("ROSSA");
            		//console.log(input_list[ind].checked);
            		console.log("Here teste")
            		if (protocol_input_arguments[i.attr("id")].default === check_helper){
                		i.prop("checked", true).trigger('change');
            		}
            		else{
                		i.prop("checked", false).trigger('change');
            		}
            		check_helper = check_helper + 1;
        	}
 		else if (["checkbox"].includes(input_list[ind].type))
        	{
                	console.log()
                	console.log(i.attr("id"))
                	console.log(protocol_input_arguments[i.attr("id")].default)

         		if (protocol_input_arguments[i.attr("id")].default === 1)
        		{
                        	console.log("on")
                        	console.log(protocol_input_arguments[i.attr("id")].default)
				i.prop("checked", true).trigger('change')
				i.prop("value", protocol_input_arguments[i.attr("id")].default)
			}
		}
		else
        	{
			//i = $(input_list[ind]);
            		console.log(i.val())
            		console.log(i.attr("id"))
            		console.log( protocol_input_arguments[i.attr("id")].default)
            		new_val = protocol_input_arguments[i.attr("id")].default
   	    		i.prop("value", new_val).trigger('change');
		}
    	}
    	if(execution_status === 'C'){
    	    	execution_status = 'NS'
    	}
    	update_button_input_status(execution_status)
    	popup_message("values reseted")
}

function reloadInputValues(){

    input_list = jQuery( ".free-input" );
    let check_helper=1;
    for ( ind = 0, len = input_list.length; ind < len; ind++ ) {
        //console.log(input_list[ind])
        i = $(input_list[ind]);
        if(["radio"].includes(input_list[ind].type) )
        {
                //console.log("ROSSA");
                //console.log(current_execution.config[i.attr("id")]);
                if (current_execution.config[i.attr("id")] === check_helper)
                {
                   i.prop("checked", true).trigger('change');
                }
                else{
                    i.prop("checked", false).trigger('change');
                }
                check_helper = check_helper + 1;
        }
        else if (["checkbox"].includes(input_list[ind].type))
        {
                console.log()
                console.log(i.attr("id"))
                console.log(current_execution.config[i.attr("id")])

         	if (current_execution.config[i.attr("id")] === 1)
        	{
                        console.log("on")
                        console.log(current_execution.config[i.attr("id")])
			i.prop("checked", true).trigger('change')
			i.prop("value", current_execution.config[i.attr("id")])
		}
	}
        else{

                i = $(input_list[ind]);
                console.log(i.val())
                console.log(i.attr("id"))
                console.log(current_execution.config[i.attr("id")])
                new_val = current_execution.config[i.attr("id")]
                i.prop("value", new_val).trigger('change');
        }
    }
    $("#execution_name").val(current_execution.name)
    if (execution_status != 'F'){
        execution_status = 'C'
    }
    update_button_input_status(execution_status)
    popup_message("values reloaded")
}

function onInputChanged(){
    if (execution_status === 'C'){
            execution_status = 'NS'
            update_button_input_status(execution_status)
        
    }
}

function disable_config_input(){
    child = $("#config-input").find("*").addClass('disabled');

}

function update_tab_visibility(execution_status){
    if (execution_status === ''){
        $('.ui.menu').find('.item').tab('change tab', 'description-tab')
    }else{
        if (execution_status === 'C' || execution_status === 'NS' ){
            $('.ui.menu').find('.item').tab('change tab', 'configuration-tab')
        }else{
            $('.ui.menu').find('.item').tab('change tab', 'execution-tab')
        }
    }
}

function update_button_input_status(execution_status){
    if (execution_status !== '' && execution_status !== 'C' && execution_status !== 'NS'){
        disable_config_input()
    }
    // new execution
    if (execution_status === ''){
        $("#exec_status > p").html("New experiment not saved yet");
        $("#createButton").removeClass('disabled');
        $("#saveButton").css("display", 'none')
        $("#saveButton").hide()
        $("#startButton").addClass('disabled');
        $("#reloadButton").addClass('disabled');
        $("#resetButton").addClass('disabled');
        $("#createNewExpButton").css("display", 'none')
        $("#deleteButton").css("display", 'none')
        $("#deleteResultsButton").css("display", 'none')
        $( "#replayButton").css("display", 'none')
        $("#resetButton").addClass('disabled');
        $("#saveNameButton").addClass('disabled');
    }
    if (execution_status === 'C'){
        $("#exec_status > p").html("Saved experiment not submited for execution");
        $("#createButton").hide()
        $("#saveButton").show()
        $("#saveButton").addClass('disabled');
        $("#startButton").removeClass('disabled');
        $("#reloadButton").addClass('disabled');
        $("#resetButton").removeClass('disabled');
        $("#createNewExpButton").hide();
        $("#deleteButton").show()
        $("#deleteResultsButton").hide();
        $( "#replayButton").css("display", 'none')
        $("#saveNameButton").addClass('disabled');
    }
    if (execution_status === 'NS'){
        $("#exec_status > p").html("Modified experiment not saved yet");
        $("#createButton").hide()
        $("#saveButton").removeClass('disabled');
        $("#startButton").addClass('disabled');
        $("#reloadButton").removeClass('disabled');
        $("#resetButton").removeClass('disabled');
        $("#createNewExpButton").hide();
        $("#deleteButton").show()
        $("#deleteResultsButton").hide();
        $( "#replayButton").css("display", 'none')
    }
    if (execution_status === 'Q'){
        $("#exec_status > p").html("Experiment saved and submited, on queue waiting for execution");
        $("#createButton").hide()
        $("#saveButton").hide();
        $("#startButton").hide();
        $("#reloadButton").hide();
        $("#resetButton").hide();
        $("#createNewExpButton").show();
        $("#deleteButton").show()
        $("#deleteResultsButton").hide();
        $( "#replayButton").css("display", 'none')
        $("#saveNameButton").addClass('disabled');
    }
    if (execution_status === 'R'){
        $("#exec_status > p").html("Experiment runnning wth results being updated");
        $("#createButton").hide()
        $("#saveButton").hide();
        $("#startButton").hide();
        $("#reloadButton").hide();
        $("#resetButton").hide();
        $("#createNewExpButton").show();
        $("#deleteButton").hide()
        $("#deleteResultsButton").hide();
        $( "#replayButton").css("display", 'none')
        $("#saveNameButton").addClass('disabled');

    }
    if (execution_status === 'F'){
        $("#exec_status > p").html("Finished experiment with final results available");
        $("#createButton").hide()
        $("#saveButton").hide();
        $("#startButton").hide();
        $("#reloadButton").hide();
        $("#resetButton").hide();
        $("#createNewExpButton").show();
        $("#deleteButton").hide()
        $("#deleteResultsButton").show();
        $( "#replayButton").show();
        $("#saveNameButton").addClass('disabled');

    }
    if (execution_status === 'A'){
        $("#exec_status > p").html("Aborted execution");
        $("#createButton").hide()
        $("#saveButton").hide();
        $("#startButton").hide();
        $("#reloadButton").hide();
        $("#resetButton").hide();
        $("#createNewExpButton").show();
        $("#deleteButton").hide()
        $("#deleteResultsButton").show();
        $( "#replayButton").css("display", 'none')
        $("#saveNameButton").addClass('disabled');

    }
    if (execution_status === 'T'){
        $("#exec_status > p").html("Timed out execution");
        $("#createButton").hide()
        $("#saveButton").hide();
        $("#startButton").hide();
        $("#reloadButton").hide();
        $("#resetButton").hide();
        $("#createNewExpButton").show();
        $("#deleteButton").show()
        $("#deleteResultsButton").hide();
        $( "#replayButton").css("display", 'none')
        $("#saveNameButton").addClass('disabled');

    }
    if (execution_status === 'E'){
        $("#exec_status > p").html("Error execution");
        $("#createButton").hide()
        $("#saveButton").hide();
        $("#startButton").hide();
        $("#reloadButton").hide();
        $("#resetButton").hide();
        $("#createNewExpButton").show();
        $("#deleteButton").show()
        $("#deleteResultsButton").hide();
        $( "#replayButton").css("display", 'none')
        $("#saveNameButton").addClass('disabled');

    }
}

function evaluted_type(i)
{
	if((protocol_input_arguments[i.attr("id")]["type"]) == 'integer'){
                        return  parseInt(i.val());
                }
                else if ((protocol_input_arguments[i.attr("id")]["type"]) == 'number')
                {
                        return Number(i.val());
                }
                else
                {
                        console.log("Type is not integer or number");
			return "ERROR"
                }

}

function retrieve_execution_configuration(){
    var form_config = {};
    input_list = jQuery( ".free-input" );
    console.log(input_list)
    for ( ind = 0, len = input_list.length; ind < len; ind++ ) {
	if(["radio"].includes(input_list[ind].type) )
	{
		console.log("ROSSA");
        console.log(input_list[ind].checked);
		if (input_list[ind].checked)
		{
			i = $(input_list[ind]);
			console.log(i.attr("id"))
			form_config[i.attr("id")] = evaluted_type(i);
		}
	}
	else {
		i = $(input_list[ind]);
		form_config[i.attr("id")] = evaluted_type(i);
    	}
    }
    return form_config ;
}


function save_experiment() {
    form_config = retrieve_execution_configuration();
    console.log(form_config );


    endpoint = "/api/v1/execution/" + current_execution.id
    method_queue = 'put'
    data_send = Object.assign({},  current_execution );

    data_send["config"] = form_config;
    
    name = $("#execution_name").val();
    if (name !== undefined){
      data_send["name"] = name 
    }
    else{
      data_send["name"] = ""
    }
   
  
    HEADERS = {
      "X-CSRFToken": X_CSRFToken,
      }
    // print out
    console.log('JSON : ' +  endpoint);
    console.log('JSON : ' +  data_send);
  
  
    axios({
      method: method_queue, 
      url: endpoint,
      headers: HEADERS,
      data: data_send,
    }).then(response => {
        execution_status = 'C'
        current_execution.config = response.data.config;
        update_button_input_status(execution_status)
        popup_message("experiment sucessfully saved")
        on_save_experiment_UI()
    }).catch(console);  
  
  }


  
function create_experiment() {
    form_config = retrieve_execution_configuration();
    console.log(form_config );


    endpoint="/api/v1/execution";
    method_queue = 'post';
    data_send = {"apparatus": apparatus_id, "protocol": protocol_id}
    
    data_send["config"] = form_config;
    
  
    if ($("#execution_name").val() !== undefined){
      name = $("#execution_name").val();
      data_send["name"] = name 
    }
    else{
      data_send["name"] = ""
    }
   
  
    HEADERS = {
      "X-CSRFToken": X_CSRFToken,
      }
    // print out
    console.log('JSON : ' +  endpoint);
    console.log('JSON : ' +  data_send);
  
  
    axios({
      method: method_queue, //you can set what request you want to be
      url: endpoint,
      headers: HEADERS,
      data: data_send,
    }).then(response => {
        // we should do a redirect to the new page.....
        // Original:
{% if not STRIPPED %}
        window.location.href = '/execution/'+String(response.data.id)
{% else %}
window.location.href = '/execution/'+String(response.data.id)+'/bare'
{% endif %}
        // Rossa Version: 
        //window.history.pushState({}, '', window.location.origin+'/execution/'+String(response.data.id));
        current_execution = response.data;
        execution_status = 'C'

        update_button_input_status(execution_status)
        popup_message("experiment sucessfully created")

    }).catch(console);  
  
}


$( document ).ready(function() {
 

    $('.tabular.menu .item').tab(); 


    $(".free-input").change(onInputChanged)

    //console.log(current_execution)
    var results_table = $('#results_table').DataTable({
            'buttons': [ 'copy',
                {
                    extend: 'csv',
                    title: document.getElementById('apparatus-name').textContent+' | Execution # '+String(current_execution.id)+' | Config- '+JSON.stringify(current_execution.config)
                },
                {
                    extend: 'excel',
                    title: document.getElementById('apparatus-name').textContent+' | Execution # '+String(current_execution.id)+' | Config- '+JSON.stringify(current_execution.config)
                },
            ], 
            order: [[0, 'desc']],
        });
        results_table.buttons().container().appendTo(
            $('div.eight.column:eq(0)', results_table.table().container()) 
        );


    on_ready_experiment_UI()

    if(execution_status != ''){
        old_status = execution_status 
        reloadInputValues()
        on_save_experiment_UI()
        execution_status = old_status 
    }else{
        resetInputValues()
        //execution_status = ''
    }

    update_button_input_status(execution_status)
    update_tab_visibility(execution_status)

   
    if(execution_status === 'Q'){
        start_pooling_queue_order()
    }
    if(execution_status === 'R'){
        start_pooling_results()
    }
    if(execution_status === 'F'){
        start_pooling_results()
    }

});
</script>
{% endblock%}
