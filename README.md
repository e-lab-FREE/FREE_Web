# Framework for remote experiments in education
## Installation guide

Navigate to your preferred folder and download the latest release of the application:

```
wget https://github.com/e-lab-FREE/FREE_Web/releases/latest/download/FREE_Web_0_6_0.zip -O FREE_Web.zip
```

Unzip the package:
```
unzip -o FREE_Web.zip
```

Create a new python virtual environment, we will be calling it `free-env`.
```
virtualenv free-env
```

Activate the virtual environment:
```
source free-env/bin/activate
```

You should now see a prefix of `(free-env)` in your command line. After that, install the dependent packages:
```
pip install -r REQUIREMENTS.txt
```

The application is configured using environment variables. You can set them using the `/freeweb/.env` file. For your convenience, there is a `.env-template` file in the same folder, that you can rename to `.env` and alter the contents.

```
mv freeweb/.env-template freeweb/.env
```

**Available settings so far**

- `PROJECT_NAME`, `PROJECT_ACRONYMUM`, `SITE_NAME` - Texts that will appear in the page header
- `TIME_ZONE` - Time zone setting for tha app in `Europe/Lisbon` format.

- `FREE_PRODUCTION` - set to `on` to enable production mode (disables sensitive error messages etc.)
- `FREE_REVERSE_PROXY` - set to `on` to be able to run the FREE behind a reverse proxy
- `FREE_SECRET` - String used in hashing function. Set either to a random string of your choice, or generate one here: https://djecrety.ir 
- `FREE_ALLOWED_HOSTS` - comma separated list of domain names/addresses; only requests to these hosts will be processed by the application. This is necessary to prevent HTTP Host header attacks. More info [here](https://docs.djangoproject.com/en/3.2/topics/security/#host-headers-virtual-hosting).

- `JANUS_SERVER_ADDRESS`, `JANUS_STREAM_KEY` - Configuration of Janus video streaming server.

In future, this file will contain database configurations/passwords etc.

Right now, the application release is shipped with pre-filled example database in `sqlite` format. 

Download the database and put it into the project root:
```
wget https://github.com/e-lab-FREE/FREE_Web/releases/latest/download/db_template_0_6_0.sqlite3 -O db.sqlite3
```

This database contains a Pendulum experiment, as well as two example user accounts.

- `wp-admin` - superuser account with access to admin interface
- `wp-guest` - guest account

Both have a password `temporary123`. This password can be changed through admin interface.

Finally, run the application:
```
daphne freeweb.asgi:application
```

By default, the webserver will be available at port 8000. To change the port, pass `-p <portnumber>` parameter to the `daphne` command. You can also force binding to specific addres by `-b <address>`.

## Update guide

Follow the first two steps of the installation guide. The commands already contain overwrite switches so that the old version will be overwritten, while `.env` and `.sqlite` files won't be touched.

A new release might contain changes to the database structure. If you are preserving your database from a previous version, run
```
python manage.py migrate
```

## HTTPS configuration
IN order to allow remote OAuth authentication (Google or Microsoft) it is necessary to activate HTTPS.
this requires the installation of SSL certificates and the execution of daphne in a with a different configuration:
### Cerificates
FREE should execute with certificates produced by the organization, can use self-signed cerificates temporarly.
Certificates cshould be generated by the network administrator and installed with the suitable names (free_private.key and free_public.crt) in the `freeweb/certificates/` directory
For testing purposed it is also possible to create a self signed certificate by running the following command on the FREE server:
```
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout freeweb/certificates/free_private.key -out freeweb/certificates/free_public.crt
```

### Server execution
After the creation or installation of the certificate the server should be executed as follows
```
daphne -e ssl:8000:privateKey=freeweb/certificates/free_private.key:certKey=freeweb/certificates/free_public.crt freeweb.asgi:application
```
If running with this configuration, users should use the following url to access FREE:
```
https://hostname.some_domain:8000/
```


### Apparatus proxy configuration
If the FREE server is configured to use HTTPS it is necessary to also configure all apparatus proxies to use HTTPS.
the version of the proxy should the the most recent change the ***server_info.ini*** file:
- `HTTPS = True`

### janus configuration
If the FREE server is configured to use HTTPS it is necessary to also further configure janus to also use HTTPS.
It is necessary to create the certificate similar rto the one used in daphne. Unfortunetly the certificate can not be created in the host (self-signed certificate), **it must be created by the network administrator of the domain**.

This certificate should be placed in a system directory before editing the janus.transport.http.jcfg configuration file:
- Disable HTTP: `http = false`
- Enable HTTPS: `https = true` 
- define the HTTPS port: `secure_port = 8088`
-Set the certificate directory:
   - `cert_pem = "/some_system_directory/janus_public.crt"`
   - `cert_key = "/some_system_directory/janus_private.key"`
In the `.env` file it is also necessary to update the protocolo of janu from `http` to `https`:
- `JANUS_SERVER_ADDRESS="https://janus-server-address:8088/janus"`

## External Authentication
FREE now allows the use of external services  from Google and Microsoft for user authentication.
To configure these services it is necessary to have HTTPS working and have a fixed public numeric address (or DNS name) for the FREE installation (for instance https://free.some-university.edu:8000/) and follow the next instructions.
### GOOGLE
Follow the instructions in https://python-social-auth.readthedocs.io/en/latest/backends/google.html#google-oauth2 / https://developers.google.com/identity/protocols/oauth2?csw=1#Registering:
- access the Google API Console: https://console.developers.google.com/
- Create a new project
- Credentials
  - Create Credentials -> OAuth client ID
- Configure Consent Screen
  - Select External User Type
  - Fill The App information screen (app name, User support email, Developer contact information)
  - Select scopes (may be empty)
  - Add a test user
- Credentials
   - Create credentials -> OAuth client ID
   - Application Type - Web application
   - Define name 
   - Add Authorized redirect URIs
     - append `/complete/google-oauth2/` to the installation URL (example: `https://free.some-university.edu:8000/complete/google-oauth2/`)
   - Create
- Download json or save the Client ID and Client Secret
- Edit .env file:
   - activate ***FREE_GOOGLE_OAUTH***:
      - `FREE_GOOGLE_OAUTH=true`
   - copy the value of ***Your Client ID*** to ***SOCIAL_AUTH_GOOGLE_OAUTH2_KEY***
   - copy ***Client Secret*** to ***SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET***
   - restart the FREE installation
### Microsoft
Follow the instructions in https://python-social-auth.readthedocs.io/en/latest/backends/microsoftgraph.html.html#google-oauth2 / https://learn.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app:
- Sign in to the Azure portal: https://portal.azure.com/
- Manage Azure Active Directory - View
- Select  App registrations on the menu
- New registration
  - Define the name of teh application
  - Select Accounts in any organizational directory (Any Azure AD directory - Multitenant) and personal Microsoft accounts (e.g. Skype, Xbox)
  - Define the redirect URI
     - Select a platform - Web
     - to create the URI, append `/complete/microsoft-graph/` to the installation URL (exampe: `https://free.some-university.edu:8000/complete/microsoft-graph/`)
  - Register
  - Save the ***Application (client) ID***
     - this value should be put in the .env file
  - Select Certificates and secrets on the menu
     - New client secret
     - Add
  - Save the ***Value***
    - this value should be put in the .env file
    :warning: **The secret Value dissapears after closing this page** :warning:
- Edit .env file:
   - activate ***FREE_MS_OAUTH***:
      - FREE_MS_OAUTH=true
   - copy  the value of ***Application (client) ID*** to ***SSOCIAL_AUTH_MICROSOFT_GRAPH_KEY***
   - copy the value of ***Secret ID*** to ***SOCIAL_AUTH_MICROSOFT_GRAPH_SECRET***
   - restart the FREE installation


